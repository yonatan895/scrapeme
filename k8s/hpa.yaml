# Horizontal Pod Autoscaler for ScrapeMe application
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: scrapeme-app-hpa
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: scrapeme
    app.kubernetes.io/component: scraper
  annotations:
    autoscaling.alpha.kubernetes.io/description: "Auto-scale ScrapeMe based on CPU and memory utilization"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: scrapeme-app
  minReplicas: 2  # Minimum replicas for high availability
  maxReplicas: 10 # Maximum replicas (adjust based on cluster capacity)
  metrics:
  # CPU-based scaling
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # Scale up when average CPU > 70%
  # Memory-based scaling  
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # Scale up when average memory > 80%
  # Custom metrics scaling (uncomment if you have custom metrics)
  # - type: Pods
  #   pods:
  #     metric:
  #       name: scrape_duration_seconds
  #     target:
  #       type: AverageValue
  #       averageValue: "30"  # Scale up if scraping takes > 30s on average
  # - type: Object
  #   object:
  #     metric:
  #       name: circuit_breaker_failures
  #     describedObject:
  #       apiVersion: v1
  #       kind: Service
  #       name: scrapeme-app
  #     target:
  #       type: Value
  #       value: "5"  # Scale up if circuit breaker failures > 5
  # Scaling behavior configuration
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60  # Wait 1 min before scaling up again
      policies:
      - type: Pods
        value: 2  # Scale up by 2 pods at a time
        periodSeconds: 60
      - type: Percent
        value: 50  # Or scale up by 50% of current replicas
        periodSeconds: 60
      selectPolicy: Max  # Use the policy that scales up more aggressively
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 min before scaling down
      policies:
      - type: Pods
        value: 1  # Scale down by 1 pod at a time
        periodSeconds: 60
      - type: Percent
        value: 25  # Or scale down by 25% of current replicas
        periodSeconds: 60
      selectPolicy: Min  # Use the policy that scales down more conservatively

---
# Vertical Pod Autoscaler (optional, requires VPA to be installed)
# Uncomment if you want automatic resource recommendation/adjustment
# apiVersion: autoscaling.k8s.io/v1
# kind: VerticalPodAutoscaler
# metadata:
#   name: scrapeme-app-vpa
#   namespace: scrapeme
#   labels:
#     app.kubernetes.io/name: scrapeme
#     app.kubernetes.io/component: scraper
# spec:
#   targetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: scrapeme-app
#   updatePolicy:
#     updateMode: "Auto"  # Auto, Initial, or Off
#   resourcePolicy:
#     containerPolicies:
#     - containerName: scrapeme
#       minAllowed:
#         cpu: 100m
#         memory: 128Mi
#       maxAllowed:
#         cpu: 4000m
#         memory: 8Gi
#       controlledResources: ["cpu", "memory"]
