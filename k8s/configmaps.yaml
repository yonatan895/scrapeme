# ConfigMap for ScrapeMe application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: scrapeme-config
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: scrapeme
    app.kubernetes.io/component: configuration
data:
  # Default sites configuration - override with your actual config
  sites.yaml: |
    sites:
      - name: example_site
        base_url: "https://quotes.toscrape.com"
        page_load_timeout_sec: 30
        wait_timeout_sec: 10
        steps:
          - name: extract_quotes
            goto_url: "/"
            fields:
              - name: title
                xpath: "//title"
              - name: quotes
                xpath: "//div[@class='quote']//span[@class='text']"
                attribute: "textContent"
                multiple: true

  # Application runtime configuration
  app.env: |
    METRICS_PORT=9090
    LOG_LEVEL=INFO
    ENABLE_POOLING=true
    MAX_WORKERS=4
    REMOTE_URL=http://selenium-hub:4444

---
# ConfigMap for Prometheus configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "/etc/prometheus/alerts.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      # ScrapeMe application metrics
      - job_name: 'scrapeme'
        static_configs:
          - targets: ['scrapeme-app:9090']
        metrics_path: /metrics
        scrape_interval: 10s
        scrape_timeout: 5s
    
      # Kubernetes pods with prometheus.io/scrape annotation
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['scrapeme']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::[0-9]+)?;([0-9]+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
    
      # Kubernetes services
      - job_name: 'kubernetes-services'
        kubernetes_sd_configs:
          - role: service
            namespaces:
              names: ['scrapeme']
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::[0-9]+)?;([0-9]+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_service_name
    
      # Selenium Hub metrics (if available)
      - job_name: 'selenium-hub'
        static_configs:
          - targets: ['selenium-hub:4444']
        metrics_path: /status
        scrape_interval: 30s
    
      # Self monitoring
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

  # Alert rules for ScrapeMe
  alerts.yml: |
    groups:
      - name: scrapeme.rules
        rules:
          - alert: ScrapeMe_Down
            expr: up{job="scrapeme"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "ScrapeMe application is down"
              description: "ScrapeMe application has been down for more than 1 minute."
          
          - alert: ScrapeMe_HighErrorRate
            expr: rate(scrape_failures_total[5m]) > 0.1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High scraping error rate"
              description: "ScrapeMe error rate is {{ $value }} errors per second."
          
          - alert: ScrapeMe_HighLatency
            expr: histogram_quantile(0.95, rate(scrape_duration_seconds_bucket[5m])) > 30
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High scraping latency"
              description: "95th percentile latency is {{ $value }} seconds."
          
          - alert: ScrapeMe_CircuitBreakerOpen
            expr: circuit_breaker_state == 2
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "Circuit breaker is open for {{ $labels.site }}"
              description: "Circuit breaker for site {{ $labels.site }} has been open for more than 1 minute."
          
          - alert: SeleniumHub_Down
            expr: up{job="selenium-hub"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Selenium Hub is down"
              description: "Selenium Hub has been unreachable for more than 2 minutes."

---
# ConfigMap for Grafana dashboard provisioning
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
data:
  dashboard-provider.yml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/grafana/dashboards

  # Simple ScrapeMe dashboard (JSON format)
  scrapeme-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ScrapeMe Metrics",
        "tags": ["scrapeme", "selenium"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Scraping Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(scrape_successes_total[5m]) / (rate(scrape_successes_total[5m]) + rate(scrape_failures_total[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percentunit",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 0.8},
                    {"color": "green", "value": 0.95}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Scraping Latency",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(scrape_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, rate(scrape_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile",
                "refId": "B"
              }
            ],
            "yAxes": [
              {"unit": "s"}
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }

---
# ConfigMap for AlertManager configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: monitoring
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alerts@scrapeme.local'
      
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
      
    receivers:
      - name: 'web.hook'
        webhook_configs:
          - url: 'http://127.0.0.1:5001/'  # Replace with your webhook URL
            send_resolved: true
      # Add email configuration when ready
      # - name: 'email-alerts'
      #   email_configs:
      #     - to: 'admin@example.com'
      #       subject: 'ScrapeMe Alert: {{ .GroupLabels.alertname }}'
      #       body: |
      #         {{ range .Alerts }}
      #         Alert: {{ .Annotations.summary }}
      #         Description: {{ .Annotations.description }}
      #         {{ end }}
    
    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance']
