apiVersion: batch/v1
kind: CronJob
metadata:
  name: scrapeme-scheduled
  namespace: scrapeme
spec:
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: scrapeme
            job-type: scheduled
        spec:
          restartPolicy: OnFailure
          serviceAccountName: scrapeme-automation
          containers:
          - name: scrapeme
            image: ghcr.io/yonatan895/scrapeme:latest
            args:
            - --config
            - /config/sites.yaml
            - --browser
            - chrome
            - --headless
            - --out
            - /artifacts/results-$(date +%Y%m%d-%H%M%S).json
            envFrom:
            - secretRef:
                name: scrapeme-secrets
            volumeMounts:
            - name: config
              mountPath: /config
            - name: artifacts
              mountPath: /artifacts
          volumes:
          - name: config
            configMap:
              name: scrapeme-config
          - name: artifacts
            persistentVolumeClaim:
              claimName: scrapeme-artifacts
