# Grafana deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: scrapeme
spec:
  replicas: 1
  strategy:
    type: Recreate  # Avoid data corruption
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
        app.kubernetes.io/name: grafana
        app.kubernetes.io/component: monitoring
    spec:
      serviceAccountName: grafana
      securityContext:
        runAsNonRoot: true
        runAsUser: 472  # grafana user
        runAsGroup: 472
        fsGroup: 472
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - name: grafana
          containerPort: 3000
          protocol: TCP
        env:
        # Security settings
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: scrapeme-secrets
              key: GRAFANA_ADMIN_PASSWORD
        - name: GF_USERS_ALLOW_SIGN_UP
          value: "false"
        - name: GF_USERS_AUTO_ASSIGN_ORG_ROLE
          value: "Viewer"
        # Server settings
        - name: GF_SERVER_ROOT_URL
          value: "%(protocol)s://%(domain)s:%(http_port)s/"
        - name: GF_SERVER_SERVE_FROM_SUB_PATH
          value: "false"
        # Database settings (SQLite by default)
        - name: GF_DATABASE_TYPE
          value: "sqlite3"
        - name: GF_DATABASE_PATH
          value: "/var/lib/grafana/grafana.db"
        # Analytics settings
        - name: GF_ANALYTICS_REPORTING_ENABLED
          value: "false"
        - name: GF_ANALYTICS_CHECK_FOR_UPDATES
          value: "false"
        # Provisioning
        - name: GF_PATHS_PROVISIONING
          value: "/etc/grafana/provisioning"
        volumeMounts:
        - name: storage
          mountPath: /var/lib/grafana
        - name: dashboards
          mountPath: /etc/grafana/provisioning/dashboards
          readOnly: true
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
          readOnly: true
        - name: tmp
          mountPath: /tmp
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: grafana-data-pvc
      - name: dashboards
        configMap:
          name: grafana-dashboards
          items:
          - key: dashboard-provider.yml
            path: dashboard-provider.yml
      - name: datasources
        configMap:
          name: grafana-datasources
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi

---
# Service Account for Grafana
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
automountServiceAccountToken: false

---
# ConfigMap for Grafana data sources
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus:9090
      isDefault: true
      editable: false
      jsonData:
        httpMethod: POST
        prometheusType: Prometheus
        prometheusVersion: 2.40.0
        timeInterval: 15s
        queryTimeout: 60s
        exemplarTraceIdDestinations:
        - name: trace_id
          datasourceUid: jaeger

---
# Service for Grafana
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
spec:
  selector:
    app: grafana
  ports:
  - name: grafana
    port: 3000
    targetPort: 3000
    protocol: TCP
  type: ClusterIP

---
# LoadBalancer service for external Grafana access (optional)
# apiVersion: v1
# kind: Service
# metadata:
#   name: grafana-external
#   namespace: scrapeme
#   labels:
#     app.kubernetes.io/name: grafana
#     app.kubernetes.io/component: monitoring
# spec:
#   selector:
#     app: grafana
#   ports:
#   - name: grafana
#     port: 3000
#     targetPort: 3000
#     protocol: TCP
#   type: LoadBalancer
#   loadBalancerSourceRanges:
#   - "10.0.0.0/8"
#   - "172.16.0.0/12"
#   - "192.168.0.0/16"
