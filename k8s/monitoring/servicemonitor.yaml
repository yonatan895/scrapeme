# ServiceMonitor for Prometheus Operator (if using Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: scrapeme-app
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: scrapeme
    app.kubernetes.io/component: monitoring
    release: prometheus  # Adjust to match your Prometheus Operator labels
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: scrapeme
      app.kubernetes.io/component: scraper
  endpoints:
  - port: metrics
    interval: 15s
    path: /metrics
    scheme: http
    scrapeTimeout: 10s
    honorLabels: false
    metricRelabelings:
    - sourceLabels: [__name__]
      regex: 'go_.*'
      action: drop  # Drop Go runtime metrics to reduce cardinality
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace

---
# ServiceMonitor for Selenium Hub
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: selenium-hub
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: selenium-hub
    app.kubernetes.io/component: monitoring
    release: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: selenium-hub
  endpoints:
  - port: hub
    interval: 30s
    path: /status
    scheme: http
    scrapeTimeout: 10s
    metricRelabelings:
    - sourceLabels: [__name__]
      regex: 'selenium_.*'
      action: keep  # Only keep Selenium-specific metrics

---
# PrometheusRule for ScrapeMe alerts (if using Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: scrapeme-rules
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: scrapeme
    app.kubernetes.io/component: monitoring
    release: prometheus
spec:
  groups:
  - name: scrapeme.rules
    interval: 30s
    rules:
    # Recording rules
    - record: scrape:success_rate
      expr: |
        (
          rate(scrape_successes_total[5m]) /
          (rate(scrape_successes_total[5m]) + rate(scrape_failures_total[5m]))
        ) * 100
      labels:
        job: scrapeme
    
    - record: scrape:p95_duration
      expr: |
        histogram_quantile(0.95, 
          rate(scrape_duration_seconds_bucket[5m])
        )
      labels:
        job: scrapeme
    
    # Alerting rules
    - alert: ScrapeMe_Down
      expr: up{job="scrapeme"} == 0
      for: 1m
      labels:
        severity: critical
        service: scrapeme
      annotations:
        summary: "ScrapeMe application is down"
        description: "ScrapeMe application {{ $labels.instance }} has been down for more than 1 minute."
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#scrapeme-down"
    
    - alert: ScrapeMe_HighErrorRate
      expr: scrape:success_rate < 90
      for: 5m
      labels:
        severity: warning
        service: scrapeme
      annotations:
        summary: "ScrapeMe high error rate"
        description: "ScrapeMe success rate is {{ $value }}% which is below 90%"
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#high-error-rate"
    
    - alert: ScrapeMe_HighLatency
      expr: scrape:p95_duration > 30
      for: 5m
      labels:
        severity: warning
        service: scrapeme
      annotations:
        summary: "ScrapeMe high latency"
        description: "ScrapeMe 95th percentile latency is {{ $value }}s which is above 30s"
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#high-latency"
    
    - alert: ScrapeMe_CircuitBreakerOpen
      expr: circuit_breaker_state == 2
      for: 1m
      labels:
        severity: warning
        service: scrapeme
      annotations:
        summary: "ScrapeMe circuit breaker open"
        description: "Circuit breaker for site {{ $labels.site }} is open"
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#circuit-breaker-open"
    
    - alert: SeleniumHub_Down
      expr: up{job="selenium-hub"} == 0
      for: 2m
      labels:
        severity: critical
        service: selenium
      annotations:
        summary: "Selenium Hub is down"
        description: "Selenium Hub has been unreachable for more than 2 minutes."
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#selenium-hub-down"
    
    - alert: ScrapeMe_PodCrashLooping
      expr: |
        rate(kube_pod_container_status_restarts_total{
          namespace="scrapeme",
          pod=~"scrapeme-app-.*"
        }[15m]) * 60 * 15 > 0
      for: 0m
      labels:
        severity: warning
        service: scrapeme
      annotations:
        summary: "ScrapeMe pod is crash looping"
        description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes."
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#pod-crash-looping"
    
    - alert: ScrapeMe_HighMemoryUsage
      expr: |
        (
          container_memory_working_set_bytes{
            namespace="scrapeme",
            pod=~"scrapeme-app-.*"
          } / 
          container_spec_memory_limit_bytes{
            namespace="scrapeme",
            pod=~"scrapeme-app-.*"
          }
        ) * 100 > 90
      for: 5m
      labels:
        severity: warning
        service: scrapeme
      annotations:
        summary: "ScrapeMe high memory usage"
        description: "Pod {{ $labels.pod }} memory usage is {{ $value }}% which is above 90%"
        runbook_url: "https://github.com/yonatan895/scrapeme/wiki/Runbooks#high-memory-usage"
