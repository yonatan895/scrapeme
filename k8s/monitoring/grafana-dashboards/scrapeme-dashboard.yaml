# Extended Grafana dashboard for ScrapeMe
apiVersion: v1
kind: ConfigMap
metadata:
  name: scrapeme-dashboard
  namespace: scrapeme
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
    grafana_dashboard: "true"
data:
  scrapeme-comprehensive.json: |
    {
      "dashboard": {
        "id": null,
        "uid": "scrapeme-main",
        "title": "ScrapeMe - Comprehensive Dashboard",
        "description": "Comprehensive monitoring dashboard for ScrapeMe Selenium automation framework",
        "tags": ["scrapeme", "selenium", "scraping", "automation"],
        "style": "dark",
        "timezone": "browser",
        "editable": true,
        "graphTooltip": 1,
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"],
          "time_options": ["5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d"]
        },
        "refresh": "10s",
        "schemaVersion": 37,
        "version": 1,
        "panels": [
          {
            "id": 1,
            "title": "Application Status",
            "type": "stat",
            "targets": [
              {
                "expr": "up{job=\"scrapeme\"}",
                "refId": "A",
                "legendFormat": "Up"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"options": {"0": {"text": "DOWN", "color": "red"}}, "type": "value"},
                  {"options": {"1": {"text": "UP", "color": "green"}}, "type": "value"}
                ],
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "green", "value": 1}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Scraping Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "(rate(scrape_successes_total[5m]) / (rate(scrape_successes_total[5m]) + rate(scrape_failures_total[5m]))) * 100",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 80},
                    {"color": "green", "value": 95}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 6, "y": 0}
          },
          {
            "id": 3,
            "title": "Active Pods",
            "type": "stat",
            "targets": [
              {
                "expr": "count(up{job=\"scrapeme\"} == 1)",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "none",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 1},
                    {"color": "green", "value": 2}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 12, "y": 0}
          },
          {
            "id": 4,
            "title": "Circuit Breaker Status",
            "type": "stat",
            "targets": [
              {
                "expr": "count by (state) (circuit_breaker_state)",
                "refId": "A",
                "legendFormat": "{{state}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"options": {"0": {"text": "CLOSED", "color": "green"}}, "type": "value"},
                  {"options": {"1": {"text": "HALF_OPEN", "color": "yellow"}}, "type": "value"},
                  {"options": {"2": {"text": "OPEN", "color": "red"}}, "type": "value"}
                ]
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 18, "y": 0}
          },
          {
            "id": 5,
            "title": "Scraping Latency (P95)",
            "type": "timeseries",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(scrape_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, rate(scrape_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, rate(scrape_duration_seconds_bucket[5m]))",
                "legendFormat": "99th percentile",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "lineWidth": 2,
                  "fillOpacity": 10
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 6,
            "title": "Scraping Rate",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(scrape_successes_total[5m])",
                "legendFormat": "Successes/sec",
                "refId": "A"
              },
              {
                "expr": "rate(scrape_failures_total[5m])",
                "legendFormat": "Failures/sec",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops",
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear",
                  "lineWidth": 2
                }
              },
              "overrides": [
                {"matcher": {"id": "byName", "options": "Failures/sec"}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]}
              ]
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          },
          {
            "id": 7,
            "title": "Resource Usage - CPU",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"scrapeme\", pod=~\"scrapeme-app-.*\"}[5m]) * 100",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear"
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}
          },
          {
            "id": 8,
            "title": "Resource Usage - Memory",
            "type": "timeseries",
            "targets": [
              {
                "expr": "container_memory_working_set_bytes{namespace=\"scrapeme\", pod=~\"scrapeme-app-.*\"}",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "min": 0,
                "custom": {
                  "drawStyle": "line",
                  "lineInterpolation": "linear"
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16}
          },
          {
            "id": 9,
            "title": "Selenium Grid Status",
            "type": "table",
            "targets": [
              {
                "expr": "up{job=\"selenium-hub\"}",
                "legendFormat": "Hub Status",
                "refId": "A"
              },
              {
                "expr": "count(up{job=~\".*selenium.*\"})",
                "legendFormat": "Total Nodes",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"options": {"0": {"text": "DOWN", "color": "red"}}, "type": "value"},
                  {"options": {"1": {"text": "UP", "color": "green"}}, "type": "value"}
                ]
              }
            },
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 24}
          }
        ],
        "templating": {
          "list": [
            {
              "name": "pod",
              "type": "query",
              "query": "label_values(up{job=\"scrapeme\"}, instance)",
              "refresh": 1,
              "multi": true,
              "includeAll": true,
              "allValue": ".*"
            }
          ]
        },
        "annotations": {
          "list": [
            {
              "name": "Deployments",
              "datasource": "Prometheus",
              "expr": "increase(kube_deployment_status_replicas_updated{namespace=\"scrapeme\"}[1m])",
              "textFormat": "Deployment updated",
              "titleFormat": "{{deployment}}",
              "iconColor": "blue",
              "enable": true
            }
          ]
        }
      }
    }
